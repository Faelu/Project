---
title: "Earth's Weakening Magnetic Field"
author: "Jun Xian Lu 1006300888"
date: "`r Sys.Date()`"
output:
  bookdown::pdf_document2:
    toc: yes
    number_sections: yes
    fig_caption: true
  bookdown::html_document2:
    toc: yes
    number_sections: yes
    fig_caption: yes
  

    
---
```{r Library and Functions, message=FALSE, warning=FALSE, include=FALSE}
library(readxl)
library(gdata)
library(tseries)
library(TSA)
library(fUnitRoots)
library(astsa)
library(bookdown)
filter = stats::filter
lag = stats::lag
RMSE = function(x,x_hat){
  ans = sqrt((sum((x-x_hat)^2))/length(x))
  return(ans)
}
```
```{r Import Data, include=FALSE}
data = read_excel("Geomagnetic_Intensity_Data.xlsx")
data
n = length(data$Year)
nTrain = n - floor(n*0.1)
nTest = n - nTrain
p_max_lag = 17
p_max_lag_S = 17
diffN1 = diff(data$North_Geomagnetic_Pole[1:nTrain])
diffN2 = diff(data$North_Geomagnetic_Pole[1:nTrain], differences = 2)
diffN2L10 = diff(diffN2, lag = 10)
diffNL5D1 = diff(diff(data$North_Geomagnetic_Pole[1:nTrain],lag = 5))
diffS1 = diff(data$South_Geomagnetic_Pole[1:nTrain])
```

```{r echo=FALSE,message=FALSE, warning=FALSE}
x.test.forecast.N10  <- matrix(0,nTest+10,1)
x.test.res.N10 <- matrix(0,nTest+10,1)
x.test.se.N10 <- matrix(0,nTest+10,1)

for (i in (nTrain : (n-1+10)) ){
  x.test.fitN10 <- sarima(data$North_Geomagnetic_Pole[1:i],1,1,6,3,1,0,5, details = FALSE, Model= FALSE)
  x.testN10 <- predict(x.test.fitN10$fit, 1)
  x.test.forecast.N10[i-nTrain+1,1] <- as.numeric(x.testN10$pred)
  x.test.res.N10[i-nTrain+1,1] <- as.numeric(x.testN10$pred) - data$North_Geomagnetic_Pole[i+1]
  x.test.se.N10[i-nTrain+1,1] <- as.numeric(x.testN10$se)
}
```

```{r echo=FALSE,message=FALSE, warning=FALSE}
x.test.forecast.S  <- matrix(0,nTest+10,1)
x.test.res.S <- matrix(0,nTest+10,1)
x.test.se.S <- matrix(0,nTest+10,1)

for (i in (nTrain : (n-1+10)) ){
  x.test.fitS <- arima(data$South_Geomagnetic_Pole[1:i], order=c(7,1,8), method = "ML", include.mean=TRUE)
  x.testS<- predict(x.test.fitS, 1)
  x.test.forecast.S[i-nTrain+1,1] <- as.numeric(x.testS$pred)
  x.test.res.S[i-nTrain+1,1] <- as.numeric(x.testS$pred) - data$South_Geomagnetic_Pole[i+1]
  x.test.se.S[i-nTrain+1,1] <- as.numeric(x.testS$se)
}
```


\newpage
# Abstract
The goal of this project is to provide an insight on Earth's change in geomagnetic field strength for the next decade. There is sufficient evidence to conclude that the north magnetic field strength will increase until the year 2028. On the other hand, there is a lack of evidence to make any conclusive statement about the south magnetic field strength.

## North Geomagnetic Pole {#Nmodel}
The model is a multiplicative seasonal ARIMA model given as $ARIMA(1,1,6)\times(3,1,0)_5$ with parameters given below and the forecasted time series.

```{r echo=FALSE, message=FALSE, warning=FALSE}
sarima(diffNL5D1,1,0,6,3,0,0,5, gg = TRUE, col = 4, Model = FALSE, details = FALSE)$fit
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
tsplot(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.N10), col = "red", lwd=2, type = "b", gg=TRUE,
       ylab='Magnetic Field Strength (Nanotesla)', xlab = 'Year', spaghetti=TRUE,cex.lab=0.7,cex.axis=0.55)
lines(x=data$Year[(nTrain+1):n], y=data$North_Geomagnetic_Pole[(nTrain+1):n], pch=18, col="blue", type="b", lty=2)
abline(v=2023, lty=2, col=4)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.N10)
      +unlist(x.test.se.N10*1.96), pch=2, col="black", type="l", lty=2)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.N10)
      -unlist(x.test.se.N10*1.96), pch=2, col="black", type="l", lty=2)
abline(v=2028, lty=2, col=4)
legend("topleft", legend=c("Predictions","Test Set"), col=c(2,5), lty=1, bty="n")
```

## South Geomagnetic Pole {#Smodel}
The model is $ARIMA(7,1,8)$ with parameters given below and the forecasted time series.

```{r echo=FALSE, message=FALSE, warning=FALSE}
sarima(diffS1,7,0,8, col = 4, gg = TRUE, Model = FALSE, details = FALSE)$fit
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
tsplot(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.S), col = "red", lwd=2, type = "b", gg=TRUE,
       ylab='Magnetic Field Strength (Nanotesla)', xlab = 'Year', spaghetti=TRUE,cex.lab=0.7,cex.axis=0.55)
lines(x=data$Year[(nTrain+1):n], y=data$South_Geomagnetic_Pole[(nTrain+1):n], pch=18, col="blue", type="b", lty=2)
abline(v=2023, lty=2, col=4)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.S)
      +unlist(x.test.se.S*1.96), pch=2, col="black", type="l", lty=2)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.S)
      -unlist(x.test.se.S*1.96), pch=2, col="black", type="l", lty=2)
legend("bottomleft", legend=c("Predictions","Test Set"), col=c(2,5), lty=1, bty="n")
```

# Introduction
Earth's magnetic field is generated by its molten iron core. The core allow free movement of electrons which generates electric currents that in turn generates the magnetic field. The magnetic field constantly changes, however, Earth's magnetic field strength overall has been decreasing for the last few centuries, this is also evident through the data set used for this project. In particular, the data set has yearly magnetic field strength starting the year 1590 to 2023 of two different locations, one is near the north pole and the other is near the south pole. Earth's magnetic field shield the Earth from crucial solar wind and solar storm which could disrupt our communication systems and electronics. Moreover, it could severely impact life on the planet since the charged particles and radiation that come from the Sun could impact weather patterns and cause health problems. Recent studies has indicated that Earth's magnetic field is undergoing significant changes which prompts the following questions: will Earth's magnetic field continue to weaken in the upcoming decade? If so, by how much?

Note that it is recommend to download and view the PDF file of this report since the figures are labeled and cross-referenced for better navigation.

# North Geomagnetic Pole 
The time series of the north geomagnetic pole was plotted using the training set (Figure \ref{fig1}). It appears that it is non-stationary.

## Model Specification
To verify the non-stationary behavior of north geomagnetic pole data, the mean level plot (Figure \ref{fig2}) and both ACF and PACF plots (Figure \ref{fig3}) were plotted. ADF tests and KPSS tests were performed (see Section \@ref(N1))
and indeed, all indicates a non-stationary behavior.

In an attempt to transform the data to a stationary one, first order differencing along with logarithmic transformation, square root transformation, and reciprocal transformation were applied, however, all gave the same result that the data is still non-stationary suggesting further differencing may be required. Figure \ref{fig4} gives the time series of the first order difference, Figure \ref{fig5} gives both the ACF and PACF plots, and Section \@ref(N2) gives the ADF tests and KPSS tests for the first order differencing.

As a result, second order differencing was employed and this time, the times series (Figure \ref{fig6}) and both ACF and PACF plots (Figure \ref{fig7}) indicates a possible stationary behavior. To verify stationarity, ADF and KPSS tests (Section \@ref(N3)) were used and it gave sufficient evidence that it may be stationary, namely, p-values less than 0.05 for all 3 different ADF tests and p-values slightly greater than 0.01 for both KPSS tests. Furthermore, it seems there is a seasonal pattern from the ACF, in addition, the p-values from the KPSS tests are quite close to 0.01 so perhaps taking an additional seasonal difference might improve the model.

This led to adding an additional seasonal difference at lag 10 (tried lag 5, 10, 15, 20, but lag 10 seems to be the best from ACF/PACF and KPSS tests) to the already second order differenced data. The time series (Figure \ref{fig8}) does not appear to be vastly different from previous time series without the seasonal difference, however, both the ACF and the PACF plots (Figure \ref{fig9}) gave stronger evidence of stationarity. Despite all this, this is not the transformation selected since the ADF and KPSS tests (Section \@ref(N4)) suggests that it may be overdifferenced. The 3 different ADF tests all gives a p-value of 0.01 and both the KPSS tests give a p-value of 0.1.

After experimenting with many different candidate transformations while taking in the consideration of overdifferencing and the appeared seasonality from previous transformations, a transformation that takes the seasonal differencing at lag 5 and a first order non-seasonal differencing came out on top. The times series of this transformation (Figure \ref{fig10}) appears stationary with no evidence of overdifferencing. The mean level plot (Figure \ref{fig11}) shows that the mean may not be constant but the deviation from constant mean does not appear to be large. The ACF and PACF plots (Figure \ref{fig12}) appears to exhibit ARIMA properties since tailing off, in addition, it has a clear signature of seasonal effect. Despite failing to reject the null hypothesis of ADF test of data having constant and trend (p-value 0.216), this does not necessarily mean it is non-stationary since the KPSS test for trend gives a p-value of 0.01817, hence the decision to reject the null hypothesis is made at $\alpha = 1\%$ (Section \@ref(N5)). Therefore, together the KPSS test for trend and ADF test for constant (p-value 0.066 hence reject at $\alpha = 10\%$), it is concluded that the underlying transformation is stationary.

## Fitting and Diagnostics {#FD}
EACF was (Section \@ref(N6)) plotted with data using transformation that takes the seasonal differencing at lag 5 and a first order non-seasonal differencing. AIC and BIC values (Section \@ref(N7)) from candidate models were calculated and sorted. Standard residuals plot, ACF of residuals plot, QQ plot, and Ljung-Box test were performed to each of candidate models, once again, using the transformed data. Ultimately, the three best performing models are ARIMA(1,0,6), ARIMA(2,0,6), and ARIMA(5,0,5), however, ARIMA(1,0,6) was chosen since it has fewer parameters (Principle of Parsimony). The standardized residual plots, ACF of residuals plot and Ljung-Box test of ARIMA(1,0,6) (Figure \ref{fig13}) confirms existence of uncorrelated errors, but the QQ plot clearly reject the normality of error. This is fine since it is difficult to have the normality of error assumption, this however will affect the prediction interval which will be further discussed in the discussion (\@ref(Diss)).

To determine the seasonal parameters, the residual plot and ACF of residuals plot were further examine, this led to first increasing the MA terms, then the AR terms, and finally, repeating the steps and reasoning in the above paragraph, the best model is given as $ARIMA(1,1,6)\times(3,1,0)_5$ (Figure \ref{fig16}). Note that the parameters of this model is the true model based off the original (non-transformed) data. This model has the lowest standard error of estimates and relatively low AIC and BIC values compare to other candidate models (Section \@ref(N8)), not to mention it has fewer parameters compare to more complex models. Unfortunately, this model still does not pass the normality of error (Shapiro test \@ref(NS1)).

## Forecasting {#FN}
The best model given as $ARIMA(1,1,6)\times(3,1,0)_5$ (Section \@ref(Nmodel)) was used to predict and compare with the test data. The prediction was done using the estimated parameters of the model and all of the training data to forecast the magnetic field strength for next year. This method is repeated until it reaches the end of the test data, the root mean square error (RMSE below) is then computed to test how well the model is performing. The RMSE is 8.77 which indicates the model is doing very well comparing to the scale of magnetic field strength which ranges from 56000 to 58000.

```{r echo=TRUE,message=FALSE, warning=FALSE}
RMSEN = RMSE(data$North_Geomagnetic_Pole[(nTrain+1):n],x.test.forecast.N10[1:nTest])
RMSEN
```

To obtain useful information, further forecasting, namely the next 10 years (from 2024 to 2023) of north geomagnetic pole strength was forecasted the same way using this model. This time instead of using the training data, the entire data was used.

```{r echo=FALSE, message=FALSE, warning=FALSE}
tsplot(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.N10), col = "red", lwd=2, type = "b", gg=TRUE,
       ylab='Magnetic Field Strength (Nanotesla)', xlab = 'Year', spaghetti=TRUE,cex.lab=0.7,cex.axis=0.55)
lines(x=data$Year[(nTrain+1):n], y=data$North_Geomagnetic_Pole[(nTrain+1):n], pch=18, col="blue", type="b", lty=2)
abline(v=2023, lty=2, col=4)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.N10)
      +unlist(x.test.se.N10*1.96), pch=2, col="black", type="l", lty=2)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.N10)
      -unlist(x.test.se.N10*1.96), pch=2, col="black", type="l", lty=2)
abline(v=2028, lty=2, col=4)
legend("topleft", legend=c("Predictions","Test Set"), col=c(2,5), lty=1, bty="n")
```

The first blue vertical dotted line indicates the year 2023 where our data set ends and the next 10 years of north geomagnetic field strength was plotted with its prediction interval. The prediction interval makes sense since it gets wider as the lead time increases. From the plot, it seems that the north geomagnetic field strength will increase for at least the next 5 years until 2028 (second blue dotted line). After 2028 the prediction interval gets so large that it becomes difficult to make any conclusion at a reasonable confidence.

# South Geomagnetic Pole
The time series of the south geomagnetic pole was plotted using the training set (Figure \ref{fig1}). It appears that it is also non-stationary with greater evidence of seasonal effect.

## Model Specification
Likewise with the north geomagnetic pole data, the mean level plot (Figure \ref{fig17}) and both ACF and PACF plots (Figure \ref{fig18}) were plotted and analyzed. ADF tests and KPSS tests (Section \@ref(S1)) were performed and all indicates a non-stationary behaviour.

Unlike the north geomagnetic pole data, the south geomagnetic pole data can be transformed to a stationary one once the first order non-seasonal difference is applied. This stionary characteristic is evident through the time series plot of first order difference (Figure \ref{fig19}), ACF and PACF plots (Figure \ref{fig20}), and both ADF and KPSS tests (Section \@ref(S2)). In particular, the ACF is tailing off and the p-value for KPSS test level is 0.1, p-value for KPSS test trend is 0.023 which can be both rejected at $\alpha = 1\%$.  Together with the ADF tests, there is sufficient evidence to conclude the transformed data is stationary and the desired model consisting of a constant/drift term.

## Fitting and Diagnostics
EACF was (Section \@ref(S3)) plotted with data using the non-seasonal first order difference. AIC and BIC values (Section \@ref(S4)) from candidate models were calculated and sorted. Standard residuals plot, ACF of residuals plot, QQ plot, and Ljung-Box test were performed to each of candidate models using the transformed data. Ultimately, the three best performing models are ARIMA(7,0,10), ARIMA(7,0,8), and ARIMA(6,0,8). Despite ARIMA(6,0,8) having 1 less parameter than ARIMA(7,0,8), ARIMA(7,0,8) was chosen since ARIMA(6,0,8) has a spike in the ACF of residual plots and smaller p-values for Ljung-Box test (Figure \ref{fig21}), suggesting that the errors may be uncorrelated. On the other hand, the standardized residuals plot, ACF of residuals plot and Ljung-Box test of ARIMA(7,0,8) suggest that the errors are uncorrelated (Figure \ref{fig22}), however, the QQ Plot (Figure \ref{fig22}) and Shapiro test (\@ref(SS1)) both suggests the non-normality of errors, just like the models from north geomagnetic pole.

## Forecasting
The best model given as $ARIMA(7,1,8)$ (Section \@ref(Smodel)) was used to predict and compare with the test data. The prediction was done identical to the method presented in section \@ref(FN). The RMSE is 4.10 which is roughly half the RMSE for the north geomagnetic pole model. This highlights the model selected is even better at predictions than the north geomagnetic pole model.

```{r echo=TRUE,message=FALSE, warning=FALSE}
RMSES = RMSE(data$South_Geomagnetic_Pole[(nTrain+1):n],x.test.forecast.S[1:nTest])
RMSES
```

Below is the plot when the model is used to forecast the south geomagnetic pole strength for the next 10 years (from 2024 to 2023). 

```{r echo=FALSE, message=FALSE, warning=FALSE}
tsplot(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.S), col = "red", lwd=2, type = "b", gg=TRUE,
       ylab='Magnetic Field Strength (Nanotesla)', xlab = 'Year', spaghetti=TRUE,cex.lab=0.7,cex.axis=0.55)
lines(x=data$Year[(nTrain+1):n], y=data$South_Geomagnetic_Pole[(nTrain+1):n], pch=18, col="blue", type="b", lty=2)
abline(v=2023, lty=2, col=4)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.S)
      +unlist(x.test.se.S*1.96), pch=2, col="black", type="l", lty=2)
lines(x=seq(data$Year[nTrain+1],2033), y = unlist(x.test.forecast.S)
      -unlist(x.test.se.S*1.96), pch=2, col="black", type="l", lty=2)
legend("bottomleft", legend=c("Predictions","Test Set"), col=c(2,5), lty=1, bty="n")
```

The first blue vertical dotted line indicates the year 2023 where our data set ends and the next 10 years of south geomagnetic field strength was plotted with its prediction interval. The prediction interval however, suggests that the south geomagnetic field strength could increase, decrease, or neither, even with small lead values such as two years ahead in 2025. Therefore, there isn't sufficient evidence to conclude anything based on the forecast.

Wide prediction interval starting at early lead values may be an indication that the selected model does not have the normality of error assumption. This will be further discussed below.


# Discussion {#Diss}
The only thing that is conclusive from this project is that the north magnetic field strength will increase until the year 2028. The lack of conclusive results may be the consequence of both selected models failing the assumption that the errors are normally distributed.

Recall that the prediction interval is derived using the assumption that the white noise terms in ARIMA model arise independently from a
normal distribution.

```{=latex}
\begin{equation}
\hat{Y}_t(l)\pm z_{1-\alpha/2}\sqrt{Var(e_{t}(l))}
\end{equation}
```

Since the selected models do not pass the tests for normality of errors, the prediction intervals may not be representative of the true prediction interval which is the limitation of the chosen models. Furthermore, seasonal ARIMA model or a periodic model may be better fit for the south geomagnetic pole data since the time series depict a strong seasonal effect (\ref{fig1}). Some attempts with the seasonal ARIMA model were made to the south geomagnetic pole data but none gave significant difference to the chosen ARIMA model while periodic models were not attempted.


# Bibliography
1. Government of Canada, N. R. C. (2019, March 1). Government of Canada / gouvernement du Canada. Government of Canada, Natural Resources Canada, Canadian Hazards Information Service. Retrieved April 9, 2023, from https://geomag.nrcan.gc.ca/mag_fld/sec-en.php 
2. Buis, Alan. NASA. (2021, November 16). Earth's magnetosphere: Protecting our planet from harmful space energy – climate change: Vital signs of the planet. NASA. Retrieved April 9, 2023, from https://climate.nasa.gov/news/3105/earths-magnetosphere-protecting-our-planet-from-harmful-space-energy/ 
3. O'Callaghan, JONATHAN.(2018, December 7). Earth's magnetic poles could start to flip. what happens then? Horizon Magazine. Retrieved April 9, 2023, from https://ec.europa.eu/research-and-innovation/en/horizon-magazine/earths-magnetic-poles-could-start-flip-what-happens-then 
4. Holt, Chris. (2021, September 14). When north goes south: Is Earth's magnetic field flipping? Astronomy.com. Retrieved April 9, 2023, from https://astronomy.com/news/2021/09/when-north-goes-south-is-earths-magnetic-field-flipping 
5. Stoffer, D. S., &amp; Poison, N. (n.d.).R you kidding. Retrieved April 9, 2023, from https://nickpoison.github.io/ 

# Appendices
All the codes used in this report (including the report itself) to generate figures/plots/results can be downloaded using the link below

https://github.com/Faelu/Project

## North Geomagnetic Pole Tests

### ADF_KPSS_N1 {#N1}
```{r, echo=FALSE}
adfTest(data$North_Geomagnetic_Pole[1:nTrain], type = "nc", lags = p_max_lag)
adfTest(data$North_Geomagnetic_Pole[1:nTrain], type = "c", lags = p_max_lag)
adfTest(data$North_Geomagnetic_Pole[1:nTrain], type = "ct", lags = p_max_lag)
adf.test(data$North_Geomagnetic_Pole[1:nTrain], k = p_max_lag)
kpss.test(data$North_Geomagnetic_Pole[1:nTrain], null = "Level")
kpss.test(data$North_Geomagnetic_Pole[1:nTrain], null = "Trend")
```

### ADF_KPSS_N2 {#N2}
```{r, echo=FALSE}
adfTest(diffN1, type = "nc", lags = p_max_lag)
adfTest(diffN1, type = "c", lags = p_max_lag)
adfTest(diffN1, type = "ct", lags = p_max_lag)
adf.test(diffN1, k = p_max_lag)
kpss.test(diffN1, null = "Level")
kpss.test(diffN1, null = "Trend")
```

### ADF_KPSS_N3 {#N3}
```{r, echo=FALSE}
adfTest(diffN2, type = "nc", lags = p_max_lag)
adfTest(diffN2, type = "c", lags = p_max_lag)
adfTest(diffN2, type = "ct", lags = p_max_lag)
adf.test(diffN2, k = p_max_lag)
kpss.test(diffN2, null = "Level")
kpss.test(diffN2, null = "Trend")
```

### ADF_KPSS_N4 {#N4}
```{r, echo=FALSE}
adfTest(diffN2L10, type = "nc", lags = p_max_lag)
adfTest(diffN2L10, type = "c", lags = p_max_lag)
adfTest(diffN2L10, type = "ct", lags = p_max_lag)
adf.test(diffN2L10, k = p_max_lag)
kpss.test(diffN2L10, null = "Level")
kpss.test(diffN2L10, null = "Trend")
```

### ADF_KPSS_N5 {#N5}
```{r, echo=FALSE}
adfTest(diffNL5D1, type = "nc", lags = p_max_lag)
adfTest(diffNL5D1, type = "c", lags = p_max_lag)
adfTest(diffNL5D1, type = "ct", lags = p_max_lag)
adf.test(diffNL5D1, k = p_max_lag)
kpss.test(diffNL5D1, null = "Level")
kpss.test(diffNL5D1, null = "Trend")
```

### N_EACF {#N6}
```{r, echo=FALSE}
eacf(diffNL5D1,ar.max=10,ma.max = 10)
```

### N_AIC_BIC {#N7}
```{r echo=TRUE, message=FALSE, warning=FALSE}
diffNL5D1.aic=matrix(0,10,10)
diffNL5D1.bic = matrix(0,10,10)
for (i in 0:9) for (j in 0:9){
  diffNL5D1.fit = arima(diffNL5D1, order = c(i,0,j), method = "ML", include.mean = TRUE)
  diffNL5D1.aic[i+1,j+1] = diffNL5D1.fit$aic
  diffNL5D1.bic[i+1,j+1] = BIC(diffNL5D1.fit)
}
diffNL5D1.aic_vec = sort(unmatrix(diffNL5D1.aic, byrow = FALSE))[1:20]
diffNL5D1.bic_vec = sort(unmatrix(diffNL5D1.bic, byrow = FALSE))[1:20]
diffNL5D1.aic_vec
diffNL5D1.bic_vec
```

### N_Shapiro {#NS1}
```{r, echo=FALSE}
diffNL5D1.fit_55 = arima(diffNL5D1, order = c(1,0,6), seasonal = list(order=c(3,0,0), period = 5), method = "ML", include.mean = TRUE)
shapiro.test(residuals(diffNL5D1.fit_55))
```

### N_AIC_BIC_ALL {#N8}
```{r echo=TRUE, message=FALSE, warning=FALSE}
diffNL5D1.fit_S1 = sarima(diffNL5D1,1,0,6,0,0,1,5, gg = TRUE, col = 4)
diffNL5D1.fit_S2 = sarima(diffNL5D1,1,0,6,0,0,3,5, gg = TRUE, col = 4)
diffNL5D1.fit_S3 = sarima(diffNL5D1,1,0,6,0,0,5,5, gg = TRUE, col = 4)
diffNL5D1.fit_S4 = sarima(diffNL5D1,1,0,6,1,0,0,5, gg = TRUE, col = 4)
diffNL5D1.fit_S5 = sarima(diffNL5D1,1,0,6,3,0,0,5, gg = TRUE, col = 4)
diffNL5D1.fit_S6 = sarima(diffNL5D1,1,0,6,5,0,0,5, gg = TRUE, col = 4)
diffNL5D1.fit_S7 = sarima(diffNL5D1,1,0,6,1,0,1,5, gg = TRUE, col = 4)
c(diffNL5D1.fit_S1$fit$aic,diffNL5D1.fit_S2$fit$aic,diffNL5D1.fit_S3$fit$aic,diffNL5D1.fit_S4$fit$aic,diffNL5D1.fit_S5$fit$aic,diffNL5D1.fit_S6$fit$aic,diffNL5D1.fit_S7$fit$aic)
diffNL5D1.fit_S1$fit
diffNL5D1.fit_S2$fit
diffNL5D1.fit_S3$fit
diffNL5D1.fit_S4$fit
diffNL5D1.fit_S5$fit
diffNL5D1.fit_S6$fit
diffNL5D1.fit_S7$fit
```

## North Geomagnetic Pole Figures
```{r figs1, echo=FALSE, fig.width=7,fig.height=6,fig.cap="\\label{fig1}Time series of North and South Geomagnetic Pole"}
tsplot(x=data$Year,y=cbind(data$North_Geomagnetic_Pole,data$South_Geomagnetic_Pole),
       col=astsa.col(c(2,5),.5), lwd=2, gg=TRUE, ylab='Magnetic Field Strength (Nanotesla)', xlab = 'Year', spaghetti=TRUE,cex.lab=0.7,cex.axis=0.55)
legend("bottomleft", legend=c("North_Geomagnetic_Pole","South_Geomagnetic_Pole"), 
       col=c(2,5), lty=1, bty="n")
```

```{r figs2, echo=FALSE, fig.width=4,fig.height=4,fig.cap="\\label{fig2} Mean Level Plot of North Geomagnetic Pole"}
cummeanNorth = cumsum(data$North_Geomagnetic_Pole[1:nTrain]) / seq_along(data$North_Geomagnetic_Pole[1:nTrain])
plot(x=data$Year[1:nTrain],y=cummeanNorth, type = "l", xlab = "Year", ylab="Mean Level",xaxt="n")
axis(side=1,at=data$Year,las=2)
```

```{r figs3, echo=FALSE,fig.cap="\\label{fig3} ACF and PACF of North Geomagnetic Pole"}
par(mfrow=c(2,1))
acf(data$North_Geomagnetic_Pole[1:nTrain], lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(data$North_Geomagnetic_Pole[1:nTrain], lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs4, echo=FALSE,fig.cap="\\label{fig4} Time Series of North Geomagnetic Pole First Order Difference"}
tsplot(x = data$Year[2:nTrain], y = diffN1, lwd = 2, gg = TRUE, col = 2, xlab = "Year",
       ylab = "Magnetic Field Strength (Nanotesla)", cex.lab=0.7,cex.axis=0.55)
```

```{r figs5, echo=FALSE,fig.cap="\\label{fig5} ACF and PACF of North Geomagnetic Pole Taking First Order Difference"}
par(mfrow=c(2,1))
acf(diffN1, lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(diffN1, lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs6, echo=FALSE,fig.cap="\\label{fig6} Time Series of North Geomagnetic Pole Second Order Difference"}
tsplot(x = data$Year[3:nTrain], y = diffN2, lwd = 2, gg = TRUE, col = 2, xlab = "Year", ylab = "Magnetic Field Strength (Nanotesla)", cex.lab=0.7,cex.axis=0.55)
```

```{r figs7, echo=FALSE,fig.cap="\\label{fig7} ACF and PACF of North Geomagnetic Pole Taking Second Order Difference"}
par(mfrow=c(2,1))
acf(diffN2, lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(diffN2, lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs8, echo=FALSE,fig.cap="\\label{fig8} Time Series of North Geomagnetic Pole Second Order Difference and an Additional Seasonal Difference at Lag 10"}
tsplot(x = data$Year[13:nTrain], y = diffN2L10, lwd = 2, gg = TRUE, col = 2, xlab = "Year", ylab = "Magnetic Field Strength (Nanotesla)", cex.lab=0.7,cex.axis=0.55)
```

```{r figs9, echo=FALSE,fig.cap="\\label{fig9} ACF and PACF of North Geomagnetic Pole Taking Second Order Difference and Seasonal Difference at Lag 10"}
par(mfrow=c(2,1))
acf(diffN2L10, lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(diffN2L10, lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs10, echo=FALSE,fig.cap="\\label{fig10} Time Series of North Geomagnetic Pole First Order Seasonal Difference at Lag 5 With a First Order Difference"}
tsplot(x = data$Year[7:nTrain], y = diffNL5D1, lwd = 2, gg = TRUE, col = 2, xlab = "Year", ylab = "Magnetic Field Strength (Nanotesla)", cex.lab=0.7,cex.axis=0.55,cex.main = 0.8)
```

```{r figs11, echo=FALSE,fig.cap="\\label{fig11} Mean Level Plot of North Geomagnetic Pole First Order Seasonal Difference at Lag 5 With a First Order Difference"}
cummeanNL5D1 =cumsum(diffNL5D1) / seq_along(diffNL5D1)
plot(x=data$Year[7:nTrain],y=cummeanNL5D1, type = "l", xlab = "Year", ylab="Mean Level",xaxt="n")
axis(side=1,at=data$Year,las=2)
```

```{r figs12, echo=FALSE,fig.cap="\\label{fig12} ACF and PACF of North Geomagnetic Pole First Order Seasonal Difference at Lag 5 With a First Order Difference"}
par(mfrow=c(2,1))
acf(diffNL5D1, lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(diffNL5D1, lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs13, echo=FALSE,fig.cap="\\label{fig13} Standardized Residuals Plot, ACF of Residuals, QQ Plot, and Ljung-Box Test for ARIMA(1,0,6)"}
sarima(diffNL5D1,1,0,6, gg = TRUE, col = 4)
```

```{r figs14, echo=FALSE,fig.cap="\\label{fig14} Standardized Residuals Plot, ACF of Residuals, QQ Plot, and Ljung-Box Test for ARIMA(2,0,6)"}
sarima(diffNL5D1,2,0,6, gg = TRUE, col = 4)
```

```{r figs15, echo=FALSE,fig.cap="\\label{fig15} Standardized Residuals Plot, ACF of Residuals, QQ Plot, and Ljung-Box Test for ARIMA(5,0,5)"}
sarima(diffNL5D1,5,0,5, gg = TRUE, col = 4)
```

```{r figs16, echo=FALSE,fig.cap="\\label{fig16} Standardized Residuals Plot, ACF of Residuals, QQ Plot, and Ljung-Box Test for SARIMA(1,0,6)(3,0,0)_5"}
sarima(diffNL5D1,1,0,6,3,0,0,5, gg = TRUE, col = 4)
```

## South Geomagnetic Pole Tests

### ADF_KPSS_S1 {#S1}

```{r, echo=FALSE}
adfTest(data$South_Geomagnetic_Pole[1:nTrain], type = "nc", lags = p_max_lag_S)
adfTest(data$South_Geomagnetic_Pole[1:nTrain], type = "c", lags = p_max_lag_S)
adfTest(data$South_Geomagnetic_Pole[1:nTrain], type = "ct", lags = p_max_lag_S)
adf.test(data$South_Geomagnetic_Pole[1:nTrain], k = p_max_lag_S)
kpss.test(data$South_Geomagnetic_Pole[1:nTrain], null = "Level")
kpss.test(data$South_Geomagnetic_Pole[1:nTrain], null = "Trend")
```

### ADF_KPSS_S2 {#S2}

```{r, echo=FALSE}
adfTest(diffS1, type = "nc", lags = p_max_lag_S)
adfTest(diffS1, type = "c", lags = p_max_lag_S)
adfTest(diffS1, type = "ct", lags = p_max_lag_S)
adf.test(diffS1, k = p_max_lag_S)
kpss.test(diffS1, null = "Level")
kpss.test(diffS1, null = "Trend")
```

### S_EACF {#S3}
```{r, echo=FALSE}
eacf(diffS1,ar.max=10,ma.max = 10)
```

### S_AIC_BIC {#S4}
```{r echo=TRUE, message=FALSE, warning=FALSE}
diffS1.aic=matrix(0,10,10)
diffS1.bic = matrix(0,10,10)
for (i in 0:9) for (j in 0:9){
  diffS1.fit = arima(diffS1, order = c(i,0,j), method = "ML", include.mean = TRUE)
  diffS1.aic[i+1,j+1] = diffS1.fit$aic
  diffS1.bic[i+1,j+1] = BIC(diffS1.fit)
}
diffS1.aic_vec = sort(unmatrix(diffS1.aic, byrow = FALSE))[1:20]
diffS1.bic_vec = sort(unmatrix(diffS1.bic, byrow = FALSE))[1:20]
diffS1.aic_vec
diffS1.bic_vec
```

### S_Shapiro {#SS1}
```{r, echo=FALSE}
diffS1.fit_22 = arima(diffS1, order = c(7,0,8), method = "ML", include.mean = TRUE)
shapiro.test(diffS1.fit_22$residuals)
```

## South Geomagnetic Pole Figures

```{r figs17, echo=FALSE, fig.width=4,fig.height=4,fig.cap="\\label{fig17} Mean Level Plot of South Geomagnetic Pole"}
cummeanSouth =cumsum(data$South_Geomagnetic_Pole[1:nTrain]) / seq_along(data$South_Geomagnetic_Pole[1:nTrain])
plot(x=data$Year[1:nTrain],y=cummeanSouth, type = "l", xlab = "Year", ylab="Mean Level",xaxt="n")
axis(side=1,at=data$Year,las=2)
```

```{r figs18, echo=FALSE,fig.cap="\\label{fig18} ACF and PACF of South Geomagnetic Pole"}
par(mfrow=c(2,1))
acf(data$South_Geomagnetic_Pole[1:nTrain], lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(data$South_Geomagnetic_Pole[1:nTrain], lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs19, echo=FALSE,fig.cap="\\label{fig19} Time Series of South Geomagnetic Pole Taking First Order Non-Seasonal Difference"}
tsplot(x = data$Year[2:nTrain], y = diffS1, lwd = 2, gg = TRUE, col = 2, xlab = "Year", ylab = "Magnetic Field Strength (Nanotesla)", cex.lab=0.7,cex.axis=0.55, main = "South Geomagnetic Pole First Order Difference")
```

```{r figs20, echo=FALSE,fig.cap="\\label{fig20} ACF and PACF of South Geomagnetic Pole Taking First Order Non-Seasonal Difference"}
par(mfrow=c(2,1))
acf(diffS1, lag.max = 50, main = "", xlab = "Lag", ylab="Sample ACF")
acf(diffS1, lag.max = 50, main = "", type = "partial", xlab = "Lag", ylab = "Sample PACF")
```

```{r figs21, echo=FALSE,fig.cap="\\label{fig21} Standardized Residuals Plot, ACF of Residuals, QQ Plot, and Ljung-Box Test for ARIMA(6,0,8)"}
sarima(diffS1,6,0,8, gg = TRUE, col = 4)
```

```{r figs22, echo=FALSE,fig.cap="\\label{fig22} Standardized Residuals Plot, ACF of Residuals, QQ Plot, and Ljung-Box Test for ARIMA(7,0,8)"}
sarima(diffS1,7,0,8, gg = TRUE, col = 4)
```
